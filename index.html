<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Consultation Training - AI Patient Simulator</title>
    
    <!-- Modern styling for the interface -->
    <style>
        /* Reset default browser styles and set custom properties for colors */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS Variables for easy color scheme changes */
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --background: #1e3a8a; /* Navy blue background */
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --success-color: #059669;
        }
        
        /* Main body styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Container for centering content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Header section styling */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        /* Modified grid layout for three equal columns */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 200px); /* Adjust height to fit viewport */
            min-height: 600px;
        }
        
        /* Card component for sections - modified for equal heights */
        .card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        /* Make card content scrollable if needed */
        .card-content {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Form input styling */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Button styling */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        /* New button style for export */
        .btn-info {
            background-color: #0ea5e9;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0284c7;
        }
        
        /* Modified push to talk button for smaller space */
        .talk-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 16px;
            margin: 15px auto;
            display: block;
            position: relative;
            overflow: hidden;
        }
        
        .talk-button.recording {
            animation: pulse 1.5s infinite;
            background-color: var(--danger-color);
        }
        
        /* Animation for recording state */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        /* Chat display area - modified for the new layout */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            background-color: #fafafa;
            margin-bottom: 15px;
        }
        
        /* Individual message styling */
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background-color: #e5e7eb;
            color: var(--text-primary);
        }
        
        .message.system {
            background-color: #f3f4f6;
            color: var(--text-secondary);
            font-style: italic;
            border-left: 4px solid var(--success-color);
            max-width: 100%;
        }
        
        /* Status indicator */
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .status.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status.info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Button group styling for control buttons - modified for vertical layout */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto;
            flex-shrink: 0;
        }
        
        .button-group button {
            width: 100%;
        }
        
        /* Responsive design for mobile devices */
        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .card {
                height: auto;
                min-height: 400px;
            }
            
            .talk-button {
                width: 100px;
                height: 100px;
            }
            
            .button-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .button-group button {
                flex: 1;
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .grid {
                gap: 15px;
            }
            
            .card {
                padding: 15px;
            }
        }
        
        /* Voice control specific adjustments */
        .voice-controls {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .voice-settings {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        
        .transcription-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        #transcriptionBox {
            flex: 1;
            min-height: 100px;
            max-height: none;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9fafb;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .talk-section {
            flex-shrink: 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header section with title and description -->
        <div class="header">
            <h1>🏥 Pharmacy Consultation Training</h1>
            <p>Practice your consultation skills with an AI-powered patient simulator</p>
        </div>
        
        <!-- Status display area for system messages -->
        <div id="status" class="status info" style="display: none;"></div>
        
        <!-- Main content grid - now three equal columns -->
        <div class="grid">
            <!-- Configuration section -->
            <div class="card">
                <h2>⚙️ Configuration</h2>
                <div class="card-content">
                    <!-- n8n webhook URL input -->
                    <div class="form-group">
                        <label for="webhookUrl">n8n Webhook URL (Chat):</label>
                        <input 
                            type="url" 
                            id="webhookUrl" 
                            placeholder="https://your-n8n-instance.com/webhook/..."
                            title="Enter your n8n webhook URL that will receive the messages"
                        >
                    </div>
                    
                    <!-- Submit webhook URL input -->
                    <div class="form-group">
                        <label for="submitWebhookUrl">n8n Submit Webhook URL:</label>
                        <input 
                            type="url" 
                            id="submitWebhookUrl" 
                            placeholder="https://your-n8n-instance.com/webhook/submit..."
                            title="Enter your n8n webhook URL for submitting conversation history"
                        >
                    </div>
                    
                    <!-- Google Sheets configuration -->
                    <div class="form-group">
                        <label for="sheetId">Google Sheet ID:</label>
                        <input 
                            type="text" 
                            id="sheetId" 
                            placeholder="1ABC...xyz"
                            title="The ID from your Google Sheets URL"
                        >
                        <button 
                            class="btn-secondary" 
                            onclick="loadSheetNames()" 
                            style="margin-top: 10px; width: 100%;"
                        >
                            📋 Get Sheet Names
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="sheetName">Sheet Name:</label>
                        <select id="sheetName" disabled>
                            <option value="">Get sheet names first...</option>
                        </select>
                        <input 
                            type="text" 
                            id="sheetNameManual" 
                            placeholder="Or type sheet name manually"
                            style="margin-top: 10px; display: none;"
                            title="Manually enter sheet name if dropdown doesn't work"
                        >
                    </div>
                    
                    <!-- Scenario selection dropdown -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="scenarioSelect">Select Scenario:</label>
                        <select id="scenarioSelect" disabled>
                            <option value="">Load sheet data first...</option>
                        </select>
                    </div>
                    
                    <button class="btn-secondary" onclick="selectRandomScenario()" style="margin-top: 10px;">
                        🎲 Random Scenario
                    </button>
                </div>
            </div>
            
            <!-- Voice control section -->
            <div class="card">
                <h2>🎙️ Voice Control</h2>
                <div class="voice-controls">
                    <!-- Voice settings -->
                    <div class="voice-settings">
                        <div class="form-group">
                            <label for="voiceSelect">AI Voice:</label>
                            <select id="voiceSelect">
                                <option value="">Loading voices...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="speechRate">Speech Rate:</label>
                            <input 
                                type="range" 
                                id="speechRate" 
                                min="0.5" 
                                max="2" 
                                step="0.1" 
                                value="1"
                            >
                            <span id="rateValue">1.0</span>
                        </div>
                    </div>
                    
                    <!-- Live transcription within voice control -->
                    <div class="transcription-section">
                        <label for="transcriptionBox">📝 Live Transcription:</label>
                        <div id="transcriptionBox">
                            <span style="color: var(--text-secondary);">Transcription will appear here when you speak...</span>
                        </div>
                    </div>
                    
                    <!-- Push to talk button -->
                    <div class="talk-section">
                        <button 
                            class="talk-button btn-danger" 
                            id="talkButton"
                            onmousedown="startRecording()"
                            onmouseup="stopRecording()"
                            onmouseleave="stopRecording()"
                            ontouchstart="startRecording()"
                            ontouchend="stopRecording()"
                        >
                            Push to Talk
                        </button>
                        
                        <p style="color: var(--text-secondary); font-size: 14px;">
                            Hold down the button to speak
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Chat display area - now in third column -->
            <div class="card">
                <h2>💬 Conversation</h2>
                <div class="chat-container" id="chatContainer">
                    <p style="text-align: center; color: var(--text-secondary);">
                        Select a scenario and start speaking to begin the consultation...
                    </p>
                </div>
                
                <!-- Control buttons with improved layout -->
                <div class="button-group">
                    <button class="btn-secondary" onclick="clearChat()">
                        🔄 Clear Chat
                    </button>
                    <button class="btn-danger" onclick="submitConversation()">
                        📤 Submit Conversation
                    </button>
                    <button class="btn-info" onclick="exportConversation()">
                        📥 Export Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript code for functionality -->
    <script>
        // ===== GLOBAL VARIABLES =====
        // These store the state of our application
        
        let recognition = null;           // Speech recognition object
        let synthesis = window.speechSynthesis; // Speech synthesis object
        let isRecording = false;          // Track if we're currently recording
        let currentScenario = null;       // Store the selected patient scenario
        let conversationHistory = [];     // Store all messages in the conversation
        let sheetData = [];              // Store data loaded from Google Sheets
        let sessionId = '';              // Unique session identifier for this training session
        let fullTranscript = '';         // Store the complete transcript during recording
        let forceStopRecognition = false; // Flag to force stop recognition
        
        // ===== INITIALIZATION =====
        // This runs when the page loads
        
        window.onload = function() {
            // Generate unique session ID for this training session
            generateSessionId();
            
            // Initialize speech recognition if available
            initializeSpeechRecognition();
            
            // Load available voices for text-to-speech
            loadVoices();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load saved configuration from localStorage
            loadSavedConfig();
            
            // Display session info
            displaySessionInfo();
        };
        
        // ===== SESSION MANAGEMENT =====
        // Generate and manage unique session IDs
        
        function generateSessionId() {
            // Generate a unique session ID using timestamp and random string
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 15);
            sessionId = `session_${timestamp}_${randomStr}`;
            
            console.log('New session started:', sessionId);
        }
        
        function displaySessionInfo() {
            // Add session ID display to the page
            const header = document.querySelector('.header');
            const sessionInfo = document.createElement('p');
            sessionInfo.style.fontSize = '0.9em';
            sessionInfo.style.color = 'var(--text-secondary)';
            sessionInfo.style.marginTop = '10px';
            sessionInfo.innerHTML = `Session ID: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${sessionId}</code>`;
            header.appendChild(sessionInfo);
        }
        
        // ===== SPEECH RECOGNITION SETUP =====
        // Configure the browser's speech recognition API
        
        function initializeSpeechRecognition() {
            // Check if browser supports speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                // Use webkit prefix for Chrome, standard for others
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Configure recognition settings
                recognition.continuous = true;       // CHANGED: Keep listening until manually stopped
                recognition.interimResults = true;   // Show interim results for live transcription
                recognition.lang = 'en-US';         // Set language
                
                // Handle speech recognition results
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    // Process all results
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Update the full transcript with any new final results
                    if (finalTranscript) {
                        fullTranscript += finalTranscript;
                    }
                    
                    // Update live transcription display
                    const transcriptionBox = document.getElementById('transcriptionBox');
                    let displayText = '';
                    
                    // Show accumulated final transcript in black
                    if (fullTranscript) {
                        displayText += `<span style="color: black;">${fullTranscript.trim()}</span>`;
                    }
                    
                    // Show interim transcript in gray
                    if (interimTranscript) {
                        if (fullTranscript) {
                            displayText += ' ';
                        }
                        displayText += `<span style="color: #6b7280; font-style: italic;">${interimTranscript}</span>`;
                    }
                    
                    transcriptionBox.innerHTML = displayText || '<span style="color: var(--text-secondary);">Listening...</span>';
                    
                    console.log('Full transcript:', fullTranscript, 'Interim:', interimTranscript);
                };
                
                // Handle recognition errors
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    
                    // Don't show error for aborted recognition (expected when we stop)
                    if (event.error !== 'aborted') {
                        showStatus('Speech recognition error: ' + event.error, 'error');
                    }
                    
                    isRecording = false;
                    updateTalkButton();
                };
                
                // Handle when recognition ends
                recognition.onend = function() {
                    console.log('Recognition ended. Force stop:', forceStopRecognition);
                    
                    // If we're forcing a stop (user released button), process the transcript
                    if (forceStopRecognition && fullTranscript.trim()) {
                        console.log('Sending full transcript:', fullTranscript);
                        addMessage(fullTranscript.trim(), 'user');
                        sendToWebhook(fullTranscript.trim());
                    }
                    
                    // Reset state
                    isRecording = false;
                    forceStopRecognition = false;
                    updateTalkButton();
                    
                    // If recording should still be active (continuous mode), restart
                    if (isRecording && !forceStopRecognition) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('Could not restart recognition:', e);
                        }
                    }
                };
            } else {
                showStatus('Speech recognition not supported in this browser', 'error');
            }
        }
        
        // ===== VOICE SYNTHESIS SETUP =====
        // Load available voices for text-to-speech
        
        function loadVoices() {
            // Get available voices
            const voices = synthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            
            // Clear existing options
            voiceSelect.innerHTML = '';
            
            // Add voice options
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            
            // Chrome loads voices asynchronously
            if (voices.length === 0) {
                synthesis.onvoiceschanged = loadVoices;
            }
        }
        
        // ===== EVENT LISTENERS =====
        // Set up various UI interactions
        
        function setupEventListeners() {
            // Speech rate slider
            document.getElementById('speechRate').addEventListener('input', function(e) {
                document.getElementById('rateValue').textContent = e.target.value;
            });
            
            // Save configuration when changed
            document.getElementById('webhookUrl').addEventListener('change', saveConfig);
            document.getElementById('submitWebhookUrl').addEventListener('change', saveConfig);
            document.getElementById('sheetId').addEventListener('change', saveConfig);
            
            // Auto-load sheet data when manual sheet name is entered
            document.getElementById('sheetNameManual').addEventListener('change', function() {
                if (this.value.trim()) {
                    saveConfig();
                    loadSheetData();
                }
            });
            document.getElementById('sheetNameManual').addEventListener('blur', function() {
                if (this.value.trim()) {
                    saveConfig();
                    loadSheetData();
                }
            });
        }
        
        // ===== RECORDING FUNCTIONS =====
        // Handle push-to-talk functionality
        
        function startRecording() {
            if (!recognition) {
                showStatus('Speech recognition not available', 'error');
                return;
            }
            
            if (!document.getElementById('webhookUrl').value) {
                showStatus('Please enter webhook URL first', 'error');
                return;
            }
            
            if (!currentScenario) {
                showStatus('Please select a patient scenario first', 'error');
                return;
            }
            
            // Clear previous transcript and reset state
            fullTranscript = '';
            forceStopRecognition = false;
            
            // Clear transcription box
            document.getElementById('transcriptionBox').innerHTML = '<span style="color: var(--text-secondary);">Listening...</span>';
            
            isRecording = true;
            updateTalkButton();
            
            try {
                recognition.start();
                showStatus('Listening...', 'info');
            } catch (error) {
                console.error('Error starting recognition:', error);
                showStatus('Error starting recording', 'error');
                isRecording = false;
                updateTalkButton();
            }
        }
        
        function stopRecording() {
            if (isRecording && recognition) {
                console.log('Stopping recording...');
                forceStopRecognition = true;
                recognition.stop();
                showStatus('Processing...', 'info');
            }
        }
        
        function updateTalkButton() {
            const button = document.getElementById('talkButton');
            if (isRecording) {
                button.classList.add('recording');
                button.innerHTML = '🔴 Recording...';
            } else {
                button.classList.remove('recording');
                button.innerHTML = '🎤 Push to Talk';
            }
        }
        
        // ===== GOOGLE SHEETS INTEGRATION =====
        // Load sheet names from Google Sheets
        
        async function loadSheetNames() {
            const sheetId = document.getElementById('sheetId').value;
            
            if (!sheetId) {
                showStatus('Please enter Sheet ID first', 'error');
                return;
            }
            
            showStatus('Loading sheet names...', 'info');
            
            try {
                // NOTE: You need to replace YOUR_API_KEY with your actual Google Sheets API key
                // Get your API key from: https://console.cloud.google.com/apis/credentials
                const apiKey = 'AIzaSyDCrWAPXe6eYugvmnO1eJb7-S4QXQj3EgQ'; // REPLACE THIS!
                
                // Make API call to get spreadsheet metadata including sheet names
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?fields=sheets.properties.title&key=${apiKey}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Extract sheet names from the response
                const sheetNames = data.sheets.map(sheet => sheet.properties.title);
                console.log('Found sheets:', sheetNames);
                
                populateSheetNameDropdown(sheetNames);
                showStatus(`Found ${sheetNames.length} sheets`, 'success');
                
            } catch (error) {
                console.error('Error loading sheet names:', error);
                
                // If API call fails, show manual input option
                showStatus('Could not load sheet names automatically. Enter manually below.', 'error');
                document.getElementById('sheetNameManual').style.display = 'block';
                
                // Enable the dropdown and add a manual entry option
                const select = document.getElementById('sheetName');
                select.disabled = false;
                select.innerHTML = '<option value="">Enter sheet name manually below...</option>';
            }
        }
        
        // Populate sheet name dropdown
        function populateSheetNameDropdown(sheetNames) {
            const select = document.getElementById('sheetName');
            select.innerHTML = '<option value="">Select a sheet...</option>';
            select.disabled = false;
            
            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            
            // Hide manual input if dropdown is populated
            document.getElementById('sheetNameManual').style.display = 'none';
            
            // Auto-load sheet data when selection changes
            select.addEventListener('change', function() {
                if (this.value) {
                    saveConfig(); // Save the selection
                    loadSheetData(); // Automatically load the data
                }
            });
        }
        
        // Get selected sheet name (from dropdown or manual input)
        function getSelectedSheetName() {
            const dropdown = document.getElementById('sheetName');
            const manual = document.getElementById('sheetNameManual');
            
            // Use dropdown value if available, otherwise use manual input
            return dropdown.value || manual.value;
        }
        
        // Load data from Google Sheets
        async function loadSheetData() {
            const sheetId = document.getElementById('sheetId').value;
            const sheetName = getSelectedSheetName();
            
            if (!sheetId || !sheetName) {
                showStatus('Please enter Sheet ID and select/enter Sheet Name', 'error');
                return;
            }
            
            showStatus(`Loading data from sheet: ${sheetName}...`, 'info');
            
            try {
                // NOTE: You need to replace YOUR_API_KEY with your actual Google Sheets API key
                const apiKey = 'AIzaSyDCrWAPXe6eYugvmnO1eJb7-S4QXQj3EgQ'; // REPLACE THIS!
